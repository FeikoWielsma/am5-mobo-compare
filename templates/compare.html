{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Comparison</h1>
    <a href="/" class="btn btn-outline-secondary">Back to List</a>
</div>

<div class="sticky-toolbar p-2 bg-light border-bottom">
    <div class="fw-bold">Dynamic View (Excel Hierarchy)</div>
</div>

<div class="table-container">
    <table class="table table-bordered table-hover" id="compareTable">
        <thead class="table-dark sticky-header">
            <tr>
                <th style="min-width: 250px; width: 250px;">Feature</th>
                {% for m in mobos %}
                <th style="min-width: 250px;" class="text-center">
                    <div>{{ m.brand }}</div>
                    <div class="fs-5">{{ m.model }}</div>
                    <span class="badge bg-secondary">{{ m.chipset }}</span>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>

            {# Recursive Macro to Render Tree #}
            {% macro render_tree(nodes, parent_path=[]) %}
            {% for node in nodes %}
            {# Check if Node has Children (Category) or is Leaf (Feature) #}
            {% if node.children %}
            {# Render Category Header #}
            {# Optimization: Only show header if it's top level or significant?
            For strict hierarchy, let's treat top-level as Section Header (Gray)
            and nested levels as indented row headers? #}

            {% if parent_path|length == 0 %}
            <tr class="table-secondary">
                <th colspan="{{ mobos|length + 1 }}">{{ node.name }}</th>
            </tr>
            {{ render_tree(node.children, parent_path + [node.name]) }}
            {% else %}
            {# It's a sub-category. Maybe just recurse.
            Or add a row indicating subcat?
            User wants clean view.
            Let's flatten visually: "Parent > Child" in the Feature column for intermediate nodes.
            #}
            {{ render_tree(node.children, parent_path + [node.name]) }}
            {% endif %}

            {% else %}
            {# It's a LEAF. Render Data Row #}
            <tr>
                {# Feature Name: Indent based on depth or showing full path?
                Simple indentation is cleaner. #}
                <th style="padding-left: {{ (parent_path|length) * 20 }}px;">
                    {% if parent_path|length > 1 %}
                    <span class="text-muted small">{{ parent_path[-1] }} &rsaquo;</span>
                    {% endif %}
                    {{ node.name }}
                </th>

                {# Render Columns #}
                {% for m in mobos %}
                <td class="text-center">
                    {# Fetch value using logic in macro or jinja context?
                    m.specs is huge nested dict.
                    We need to traverse it using keys in parent_path + [node.name].
                    But wait, unflattening logic used strict keys.
                    Ideally, we stored the 'key' (pipe delimited) in the node structure?
                    Yes, build_header_tree in dataloader assigns 'key' to leaf nodes.
                    #}

                    {# Helper to resolve nested dict by list of keys #}
                    {% set ns = namespace(current=m.specs) %}
                    {% for part in parent_path %}
                    {% if ns.current and part in ns.current %}
                    {% set ns.current = ns.current[part] %}
                    {% else %}
                    {% set ns.current = {} %}
                    {% endif %}
                    {% endfor %}

                    {# Final Access #}
                    {% if ns.current and node.name in ns.current %}
                    {# Value found #}
                    {{ ns.current[node.name] }}
                    {% else %}
                    <span class="text-muted small">-</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endif %}
            {% endfor %}
            {% endmacro %}

            {# Start Rendering with Root Nodes #}
            {{ render_tree(structure) }}

        </tbody>
    </table>
</div>

{% endblock %}