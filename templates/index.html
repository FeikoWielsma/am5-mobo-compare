{% extends "base.html" %}
{% from 'macros.html' import chipset_badge, ff_badge %}

{% block content %}
<!-- Search and Stats -->
<!-- Search and Stats -->
<!-- Search and Stats -->
<div class="p-2 bg-light border-bottom mb-3">
    <div class="row align-items-center g-2">
        <div class="col-auto">
            <a href="/" class="text-decoration-none text-dark">
                <h5 class="mb-0 fw-bold">AM5 DB</h5>
            </a>
        </div>
        <div class="col-md-4">
            <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="globalSearch" class="form-control" placeholder="Global search...">
            </div>
        </div>
        <div class="col text-center">
            <div class="compare-trigger-area btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" id="selectAllVisibleBtn"
                    title="Select all currently visible motherboards">Select Visible</button>
                <button class="btn btn-primary px-4 shadow-sm" id="compareBtnTop" disabled>
                    Compare (<span id="selectedCountTop">0</span>)
                </button>
                <button class="btn btn-outline-danger" id="clearSelectionTopBtn"
                    title="Clear all selections">Clear</button>
            </div>
        </div>
        <div class="col-auto text-end">
            <small class="text-muted me-2">Data: <a
                    href="https://docs.google.com/spreadsheets/d/1NQHkDEcgDPm34Mns3C93K6SJoBnua-x9O-y_6hv8sPs/edit?gid=2064683589#gid=2064683589"
                    target="_blank" class="text-decoration-none">Thriplerex</a></small>
            <span class="badge bg-light text-dark border p-2" id="countDisplay">{{ mobos|length }} mobos</span>
        </div>
    </div>
</div>

<div class="table-container shadow-sm rounded border">
    <table class="table table-hover mb-0" id="moboTable">
        <thead class="table-dark sticky-header">
            <tr>
                <th style="width: 50px;">Select</th>
                <th class="sortable" data-sort="brand" style="cursor: pointer;">Brand <span
                        class="sort-indicator"></span></th>
                <th class="sortable" data-sort="chipset" style="cursor: pointer;">Chipset <span
                        class="sort-indicator"></span></th>
                <th class="sortable" data-sort="form_factor" style="cursor: pointer;">Form Factor <span
                        class="sort-indicator"></span></th>
                <th class="sortable" data-sort="model" style="cursor: pointer;">Model <span
                        class="sort-indicator"></span></th>
                <!-- Dynamic Columns Container -->
                <!-- JS will inject headers here -->

                <th id="addColumnHeader" style="width: 50px;" class="text-center align-middle">
                    <button class="btn btn-sm btn-outline-success" id="addDynamicColBtn" title="Add Column">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </th>
            </tr>
            <!-- Filter Row -->
            <tr class="filter-row bg-secondary">
                <td></td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="brand">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="chipset">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="form_factor">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="model">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <!-- JS will inject filter cells here -->
                <td id="addColumnFilterCell"></td>
            </tr>
        </thead>
        <tbody id="moboTableBody">
            <!-- Rendered by JS -->
        </tbody>
    </table>
</div>

<div class="compare-bar shadow-lg" id="compareBar" style="display: none;">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="fw-bold"><i class="bi bi-layers-half me-2"></i><span id="selectedCount">0</span> motherboards
            selected</span>
        <div>
            <button class="btn btn-outline-light me-2 btn-sm" id="clearSelection">Clear All</button>
            <button class="btn btn-primary" id="compareBtn">Compare Now</button>
        </div>
    </div>
</div>

<!-- Template for Feature Selector (Hidden) -->
<div style="display: none;">
    <select id="featureSelectorTemplate">
        <option value="">-- Pick Feature --</option>
        {%- macro render_options_tpl(items, path_labels=[]) -%}
        {%- set excluded_keys = ['brand', 'model', 'chipset', 'form_factor'] -%}
        {%- for item in items -%}
        {%- if item.children -%}
        {%- if path_labels|length == 0 -%}
        <optgroup label="{{ item.name }}">
            {{ render_options_tpl(item.children, [item.name]) }}
        </optgroup>
        {%- else -%}
        {{ render_options_tpl(item.children, path_labels + [item.name]) }}
        {%- endif -%}
        {%- elif item.key and item.key not in excluded_keys -%}
        <option value="{{ item.key }}">
            {{ (path_labels[1:] + [item.name]) | join(' > ') if path_labels|length > 1 else item.name }}
        </option>
        {%- endif -%}
        {%- endfor -%}
        {%- endmacro -%}
        {{ render_options_tpl(structure) }}
    </select>
</div>

<!-- Scorecard Modal -->
<div class="modal fade" id="scorecardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="scorecardModalLabel">Motherboard Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <!-- Connectivity -->
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded h-100">
                            <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-globe me-2"></i>Connectivity</h6>
                            <dl class="row mb-0 small">
                                <dt class="col-sm-4 text-muted">LAN</dt>
                                <dd class="col-sm-8 fw-bold" id="modal-lan">-</dd>
                                <dt class="col-sm-4 text-muted">Wireless</dt>
                                <dd class="col-sm-8" id="modal-wifi">-</dd>
                                <dt class="col-sm-4 text-muted">Audio</dt>
                                <dd class="col-sm-8" id="modal-audio">-</dd>
                                <dt class="col-sm-4 text-muted">USB-C Int.</dt>
                                <dd class="col-sm-8" id="modal-usbc">-</dd>
                                <dt class="col-sm-4 text-muted">BIOS Flash</dt>
                                <dd class="col-sm-8" id="modal-bios">-</dd>
                            </dl>
                        </div>
                    </div>
                    <!-- Power & Cooling -->
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded h-100">
                            <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-lightning-charge me-2"></i>Power &
                                Cooling</h6>
                            <dl class="row mb-0 small">
                                <dt class="col-sm-4 text-muted">VRM</dt>
                                <dd class="col-sm-8 fw-bold" id="modal-vrm">-</dd>
                                <dt class="col-sm-4 text-muted">VCore</dt>
                                <dd class="col-sm-8 text-muted" id="modal-vcore">-</dd>
                                <dt class="col-sm-4 text-muted">Fans</dt>
                                <dd class="col-sm-8" id="modal-fans">-</dd>
                                <dt class="col-sm-4 text-muted">ARGB</dt>
                                <dd class="col-sm-8" id="modal-argb">-</dd>
                            </dl>
                        </div>
                    </div>
                    <!-- Storage & Expansion -->
                    <div class="col-md-12">
                        <div class="p-3 bg-white border rounded">
                            <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-cpu me-2"></i>Storage & Expansion</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="text-muted small fw-bold mb-1 uppercase">M.2 Slots</div>
                                    <div id="modal-m2-list" class="small"></div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-muted small fw-bold mb-1 uppercase">PCIe x16</div>
                                    <div id="modal-pcie-list" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- USB Rear -->
                    <div class="col-md-12">
                        <div class="p-3 bg-dark text-white rounded">
                            <h6 class="fw-bold mb-2"><i class="bi bi-usb-symbol me-2"></i>Rear USB Configuration</h6>
                            <div class="d-flex align-items-center gap-3">
                                <div class="border-end pe-3">
                                    <span class="fs-4 fw-bold" id="modal-usb-total">0</span>
                                    <div class="small text-muted">Total Ports</div>
                                </div>
                                <div id="modal-usb-badges" class="d-flex flex-wrap gap-1">
                                    <!-- Badges injected by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>





{% endblock %}

{% block scripts %}
<script>
    // Pass full data to JS
    const MOBO_DATA = {{ mobos | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}