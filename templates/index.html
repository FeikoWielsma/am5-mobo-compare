{% extends "base.html" %}
{% from 'macros.html' import chipset_badge, ff_badge %}

{% block content %}
<!-- Search and Stats -->
<div class="row mb-3 align-items-center">
    <div class="col-md-4">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="globalSearch" class="form-control" placeholder="Global search...">
        </div>
    </div>
    <div class="col-md-4 text-center">
        <div class="compare-trigger-area">
            <button class="btn btn-primary px-4 shadow-sm" id="compareBtnTop" disabled>
                Compare Selected (<span id="selectedCountTop">0</span>)
            </button>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <span class="badge bg-light text-dark border p-2" id="countDisplay">{{ mobos|length }} motherboards
            loaded</span>
    </div>
</div>

<div class="table-container shadow-sm rounded border">
    <table class="table table-hover mb-0" id="moboTable">
        <thead class="table-dark sticky-top">
            <tr>
                <th style="width: 50px;">Select</th>
                <th>Brand</th>
                <th>Chipset</th>
                <th>Model</th>
                <th>Form Factor</th>
                <!-- Dynamic Column 1 -->
                <th class="dynamic-col-header" data-col-index="1">
                    <select class="form-select form-select-sm feature-selector" data-col-index="1">
                        <option value="">-- Pick Feature 1 --</option>
                        {%- macro render_options(items, path_labels=[]) -%}
                        {%- for item in items -%}
                        {%- if item.children -%}
                        {%- if path_labels|length == 0 -%}
                        <optgroup label="{{ item.name }}">
                            {{ render_options(item.children, [item.name]) }}
                        </optgroup>
                        {%- else -%}
                        {{ render_options(item.children, path_labels + [item.name]) }}
                        {%- endif -%}
                        {%- elif item.key -%}
                        <option value="{{ item.key }}">
                            {{ (path_labels[1:] + [item.name]) | join(' > ') if path_labels|length > 1 else item.name }}
                        </option>
                        {%- endif -%}
                        {%- endfor -%}
                        {%- endmacro -%}
                        {{ render_options(structure) }}
                    </select>
                </th>
                <!-- Dynamic Column 2 -->
                <th class="dynamic-col-header" data-col-index="2">
                    <select class="form-select form-select-sm feature-selector" data-col-index="2">
                        <option value="">-- Pick Feature 2 --</option>
                        {{ render_options(structure) }}
                    </select>
                </th>
            </tr>
            <!-- Filter Row -->
            <tr class="filter-row bg-secondary">
                <td></td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="brand">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="chipset">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="model">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="form_factor">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="dyn1">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
                <td>
                    <div class="dropdown filter-dropdown" data-col="dyn2">
                        <button class="btn btn-sm btn-outline-light w-100 dropdown-toggle filter-btn" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside">All</button>
                        <div class="dropdown-menu p-2 shadow"></div>
                    </div>
                </td>
            </tr>
        </thead>
        <tbody id="moboTableBody">
            <!-- Rendered by JS -->
        </tbody>
    </table>
</div>

<div class="compare-bar shadow-lg" id="compareBar" style="display: none;">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="fw-bold"><i class="bi bi-layers-half me-2"></i><span id="selectedCount">0</span> motherboards
            selected</span>
        <div>
            <button class="btn btn-outline-light me-2 btn-sm" id="clearSelection">Clear All</button>
            <button class="btn btn-primary" id="compareBtn">Compare Now</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Pass full data to JS
    const MOBO_DATA = {{ mobos | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}